#!groovy

@Library("Infrastructure")

def type = "java"
def product = "pip"
def component = "data-management"

static LinkedHashMap<String, Object> secret(String secretName, String envVar) {
  [ $class: 'AzureKeyVaultSecret',
    secretType: 'Secret',
    name: secretName,
    version: '',
    envVariable: envVar
  ]
}

withPipeline(type, product, component) {

  enableSlackNotifications('#pip-build-notices')
  enableAksStagingDeployment()
  disableLegacyDeployment()
  enableApiGatewayTest()

   before('test') {
    sh "echo 'Validate Swaggr'"
    sh swaggerValidate()
  }
}

static String swaggerValidate(){
  def swaggerPath = "infrastructure/resources/swagger/api-swagger.json"
  def branchName = env.BRANCH_NAME
  def script = "url=\"https://raw.githubusercontent.com/hmcts/$product-$component/$branchName/$swaggerPath\"" +
      "CHECK=$(curl -X \"GET\" \"https://validator.swagger.io/validator/debug?url=\${url}\" --silent)" +
      "if [[ \$CHECK != \"{}\" ]]; then" +
      "  echo -e \"\\nSorry this is an invalid Swagger:\\n\$CHECK\\n\"" +
      "  exit 1" +
      "fi;" +

    return script;
}