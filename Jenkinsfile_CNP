#!groovy

@Library("Infrastructure")

import uk.gov.hmcts.contino.GradleBuilder
import uk.gov.hmcts.contino.Kubectl
import uk.gov.hmcts.contino.DockerImage
import uk.gov.hmcts.pipeline.TeamConfig

def type = "java"
def product = "pip"
def component = "data-management"
def kv = product + '-ss-kv'

GradleBuilder builder = new GradleBuilder(this, product)

def setupTestSecrets() {
  def bootstap_env = env.ENV == "prod" || env.ENV == "demo" || env.ENV == "sbox" ? env.ENV : "stg"
  azureKeyVault(
    keyVaultURL: "https://pip-bootstrap-${bootstap_env}-kv.vault.azure.net/",
    secrets: [
      secret('app-pip-data-management-id', 'CLIENT_ID'),
      secret('app-pip-data-management-pwd', 'CLIENT_SECRET'),
      secret('app-pip-data-management-scope', 'APP_URI'),
      secret('app-pip-subscription-management-scope', 'SUBSCRIPTION_MANAGEMENT_AZ_API'),
      secret('app-pip-account-management-scope', 'ACCOUNT_MANAGEMENT_AZ_API'),
      secret('app-pip-publication-services-scope', 'PUBLICATION_SERVICES_AZ_API'),
      secret('app-tenant', 'TENANT_ID'),
      secret('test-user-id', 'TEST_USER_ID'),
      secret('b2c-test-system-admin-account-provenance-id', 'SYSTEM_ADMIN_PROVENANCE_ID'),
      secret('app-pip-subscription-management-id', 'CLIENT_ID_FT'),
      secret('app-pip-subscription-management-pwd', 'CLIENT_SECRET_FT'),
      secret('shared-storageaccount-connection-string', 'CONNECTION_STRING'),
    ]) {
    env.CLIENT_ID = "${CLIENT_ID}"
    env.CLIENT_SECRET = "${CLIENT_SECRET}"
    env.APP_URI = "${APP_URI}"
    env.SUBSCRIPTION_MANAGEMENT_AZ_API = "${SUBSCRIPTION_MANAGEMENT_AZ_API}"
    env.ACCOUNT_MANAGEMENT_AZ_API = "${ACCOUNT_MANAGEMENT_AZ_API}"
    env.PUBLICATION_SERVICES_AZ_API = "${PUBLICATION_SERVICES_AZ_API}"
    env.SYSTEM_ADMIN_PROVENANCE_ID = "${SYSTEM_ADMIN_PROVENANCE_ID}"
    env.TENANT_ID = "${TENANT_ID}"
    env.TEST_USER_ID = "${TEST_USER_ID}"
    env.CLIENT_ID_FT = "${CLIENT_ID_FT}"
    env.CLIENT_SECRET_FT = "${CLIENT_SECRET_FT}"
    env.CONNECTION_STRING = "${CONNECTION_STRING}"
  }
}

//def setupDevTestSecrets(product, component) {
//  withAksClient('nonprod', product) {
//    def dockerImage = new DockerImage(product, component, null, env.BRANCH_NAME, env.GIT_COMMIT, env.LAST_COMMIT_TIMESTAMP)
//    def subscription = env.SUBSCRIPTION_NAME
//    def aksServiceName = dockerImage.getAksServiceName().toLowerCase()
//    def storageSecretRef = "storage-secret-${aksServiceName}-blobstorage"
//    def namespace = new TeamConfig(this).getNameSpace(product)
//    def kubectl = new Kubectl(this, subscription, namespace)
//
//    kubectl.login()
//
//    env.STORAGE_ACCOUNT_NAME = kubectl.getSecret("storage-account-${aksServiceName}-blobstorage", namespace, "{.data.storage_account_name}")
//    env.STORAGE_ACCOUNT_URL = kubectl.getSecret(storageSecretRef, namespace, "{.data.blobEndpoint}")
//    env.STORAGE_ACCOUNT_KEY = kubectl.getSecret(storageSecretRef, namespace, "{.data.accessKey}")
//  }
//}
//
//def setupStgTestSecrets() {
//  def bootstap_env = env.ENV == "prod" || env.ENV == "demo" || env.ENV == "sbox" ? env.ENV : "stg"
//  azureKeyVault(
//    keyVaultURL: "https://pip-bootstrap-${bootstap_env}-kv.vault.azure.net/",
//    secrets: [
//      secret('shared-storageaccount-name', 'STORAGE_ACCOUNT_NAME'),
//    ]) {
//    env.STORAGE_ACCOUNT_NAME = "${STORAGE_ACCOUNT_NAME}"
//    env.MANAGED_IDENTITY_CLIENT_ID = "8d0ead51-3b31-44df-a78e-ada4eea9fe87"
//  }
//}

static LinkedHashMap<String, Object> secret(String secretName, String envVar) {
  [ $class: 'AzureKeyVaultSecret',
    secretType: 'Secret',
    name: secretName,
    version: '',
    envVariable: envVar
  ]
}

withPipeline(type, product, component) {

  onMaster() {
    env.ENV = 'stg'
  }
  onPR() {
    env.ENV = 'dev'
  }
  onDemo {
    env.ENV = 'demo'
  }
  onPerftest {
    env.ENV = 'perftest'
  }
  onIthc {
    env.ENV = 'ithc'
  }

  setupTestSecrets()
  enableDbMigration(kv)
  enableSlackNotifications('#pip-build-notices')
  enableAksStagingDeployment()
  disableLegacyDeployment()
  enableApiGatewayTest()

   def branchName = env.CHANGE_BRANCH ?: env.BRANCH_NAME
   before('test') {
    sh "echo 'Validate Swaggr'"
    sh swaggerValidate(branchName)
  }

//  before('functionalTest:dev') {
//    setupDevTestSecrets(product, component)
//  }
//
//  before('functionalTest:stg') {
//    setupStgTestSecrets()
//  }

  afterAlways('test') {
    builder.gradle('integration')
  }
}

static String swaggerValidate(String branchName){
  def repoName = "pip-data-management"
  def swaggerPath = "infrastructure/resources/swagger/api-swagger.json"
  def script = 'url="https://raw.githubusercontent.com/hmcts/' + repoName + '/' + branchName + '/' + swaggerPath + '";' +
  'CHECK=$(curl -X "GET" "https://validator.swagger.io/validator/debug?url=\${url}" --silent);' +
  'if [[ "\$CHECK" != "{}" ]]; then' +
  '  echo -e "\\nSorry this is an invalid Swagger:\\n\$CHECK\\n";' +
  '  exit 1;' +
  'fi;'

  return script
}
